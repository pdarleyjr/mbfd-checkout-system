{"version":3,"file":"receipt-nVCul5S8.js","sources":["../../src/lib/receipt.ts"],"sourcesContent":["/**\n * Receipt generation and hosting utilities\n */\n\nimport type { InspectionSubmission } from '../types';\n\nconst API_BASE_URL = 'https://mbfd-github-proxy.pdarleyjr.workers.dev/api';\n\nexport interface ReceiptItem {\n  compartment?: string;\n  itemName: string;\n  status: 'present' | 'missing' | 'damaged';\n  notes?: string;\n}\n\nexport interface ReceiptPayload {\n  inspector: string;\n  apparatus: string;\n  date: string; // ISO format\n  items: ReceiptItem[];\n  summary?: {\n    totalItems?: number;\n    issuesFound?: number;\n  };\n}\n\nexport interface ReceiptResponse {\n  ok: boolean;\n  id: string;\n  url: string;\n}\n\n/**\n * Build receipt payload from inspection submission data\n */\nexport function buildReceiptPayloadFromInspection(\n  submission: InspectionSubmission\n): ReceiptPayload {\n  const { user, apparatus, date, items, defects } = submission;\n\n  // Build a map of item names to compartments for lookup\n  // For now, we'll use defects which already have compartment info\n  // and items without compartments will show as N/A\n  const defectCompartmentMap = new Map<string, string>();\n  defects.forEach(d => {\n    defectCompartmentMap.set(d.item, d.compartment);\n  });\n\n  const receiptItems: ReceiptItem[] = items.map(item => ({\n    compartment: defectCompartmentMap.get(item.name) || undefined,\n    itemName: item.name,\n    status: item.status || 'present',\n    notes: item.notes,\n  }));\n\n  const issuesFound = receiptItems.filter(i => i.status !== 'present').length;\n\n  return {\n    inspector: `${user.name} (${user.rank})`,\n    apparatus,\n    date,\n    items: receiptItems,\n    summary: {\n      totalItems: items.length,\n      issuesFound,\n    },\n  };\n}\n\n/**\n * Create a hosted receipt by POSTing to the worker\n * @throws Error if receipt creation fails\n */\nexport async function createHostedReceipt(\n  apiBase: string,\n  payload: ReceiptPayload,\n  adminPassword?: string\n): Promise<ReceiptResponse> {\n  const headers: HeadersInit = {\n    'Content-Type': 'application/json',\n  };\n\n  if (adminPassword) {\n    headers['X-Admin-Password'] = adminPassword;\n  }\n\n  const response = await fetch(`${apiBase}/receipts`, {\n    method: 'POST',\n    headers,\n    body: JSON.stringify(payload),\n  });\n\n  if (!response.ok) {\n    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));\n    throw new Error(\n      `Failed to create receipt: ${response.status} ${errorData.message || response.statusText}`\n    );\n  }\n\n  return await response.json();\n}\n\n/**\n * Build a fallback Markdown receipt for embedding in GitHub issues\n * Used when hosted receipt creation fails\n */\nexport function buildReceiptMarkdown(payload: ReceiptPayload): string {\n  const { inspector, apparatus, date, items, summary } = payload;\n  const dateFormatted = new Date(date).toLocaleString('en-US', {\n    dateStyle: 'full',\n    timeStyle: 'short',\n  });\n\n  const totalItems = summary?.totalItems ?? items.length;\n  const issuesFound = summary?.issuesFound ?? items.filter(i => i.status !== 'present').length;\n\n  const itemsMarkdown = items\n    .map(item => {\n      const statusEmoji =\n        item.status === 'present' ? '‚úÖ' : item.status === 'missing' ? '‚ùå' : '‚ö†Ô∏è';\n      const statusText =\n        item.status === 'present' ? 'Present' : item.status === 'missing' ? 'Missing' : 'Damaged';\n\n      return `- **${item.compartment || 'N/A'}**: ${item.itemName} - ${statusEmoji} ${statusText}${item.notes ? ` (_${item.notes}_)` : ''}`;\n    })\n    .join('\\n');\n\n  return `\n## üöí Inspection Receipt\n\n**Apparatus:** ${apparatus}  \n**Inspector:** ${inspector}  \n**Date:** ${dateFormatted}\n\n### üìä Summary\n- **Items Checked:** ${totalItems}\n- **Issues Found:** ${issuesFound}\n\n### Inspection Details\n${itemsMarkdown}\n\n---\n_This receipt was embedded as a fallback. Hosted receipt creation was unavailable._\n`.trim();\n}\n\n/**\n * Helper to get the admin password from the github service or local storage\n * This mimics the pattern used in github.ts\n */\nexport function getAdminPasswordHeader(): string | undefined {\n  // This should ideally come from the github service singleton\n  // For now, we'll rely on callers providing it explicitly\n  return undefined;\n}\n\n/**\n * Convenience function to create a receipt for a submission\n * Returns the receipt URL or null if creation failed\n */\nexport async function tryCreateReceipt(\n  submission: InspectionSubmission,\n  adminPassword?: string\n): Promise<string | null> {\n  try {\n    const payload = buildReceiptPayloadFromInspection(submission);\n    const response = await createHostedReceipt(API_BASE_URL, payload, adminPassword);\n    console.log(`Created hosted receipt: ${response.url}`);\n    return response.url;\n  } catch (error) {\n    console.error('Failed to create hosted receipt:', error);\n    return null;\n  }\n}\n"],"names":["buildReceiptPayloadFromInspection","submission","user","apparatus","date","items","defects","defectCompartmentMap","d","receiptItems","item","issuesFound","i","createHostedReceipt","apiBase","payload","adminPassword","headers","response","errorData","buildReceiptMarkdown","inspector","summary","dateFormatted","totalItems","itemsMarkdown","statusEmoji","statusText"],"mappings":"AAmCO,SAASA,EACdC,EACgB,CAChB,KAAM,CAAE,KAAAC,EAAM,UAAAC,EAAW,KAAAC,EAAM,MAAAC,EAAO,QAAAC,GAAYL,EAK5CM,MAA2B,IACjCD,EAAQ,QAAQE,GAAK,CACnBD,EAAqB,IAAIC,EAAE,KAAMA,EAAE,WAAW,CAChD,CAAC,EAED,MAAMC,EAA8BJ,EAAM,IAAIK,IAAS,CACrD,YAAaH,EAAqB,IAAIG,EAAK,IAAI,GAAK,OACpD,SAAUA,EAAK,KACf,OAAQA,EAAK,QAAU,UACvB,MAAOA,EAAK,KAAA,EACZ,EAEIC,EAAcF,EAAa,UAAYG,EAAE,SAAW,SAAS,EAAE,OAErE,MAAO,CACL,UAAW,GAAGV,EAAK,IAAI,KAAKA,EAAK,IAAI,IACrC,UAAAC,EACA,KAAAC,EACA,MAAOK,EACP,QAAS,CACP,WAAYJ,EAAM,OAClB,YAAAM,CAAA,CACF,CAEJ,CAMA,eAAsBE,EACpBC,EACAC,EACAC,EAC0B,CAC1B,MAAMC,EAAuB,CAC3B,eAAgB,kBAAA,EAGdD,IACFC,EAAQ,kBAAkB,EAAID,GAGhC,MAAME,EAAW,MAAM,MAAM,GAAGJ,CAAO,YAAa,CAClD,OAAQ,OACR,QAAAG,EACA,KAAM,KAAK,UAAUF,CAAO,CAAA,CAC7B,EAED,GAAI,CAACG,EAAS,GAAI,CAChB,MAAMC,EAAY,MAAMD,EAAS,KAAA,EAAO,MAAM,KAAO,CAAE,QAAS,eAAA,EAAkB,EAClF,MAAM,IAAI,MACR,6BAA6BA,EAAS,MAAM,IAAIC,EAAU,SAAWD,EAAS,UAAU,EAAA,CAE5F,CAEA,OAAO,MAAMA,EAAS,KAAA,CACxB,CAMO,SAASE,EAAqBL,EAAiC,CACpE,KAAM,CAAE,UAAAM,EAAW,UAAAlB,EAAW,KAAAC,EAAM,MAAAC,EAAO,QAAAiB,GAAYP,EACjDQ,EAAgB,IAAI,KAAKnB,CAAI,EAAE,eAAe,QAAS,CAC3D,UAAW,OACX,UAAW,OAAA,CACZ,EAEKoB,EAAaF,GAAS,YAAcjB,EAAM,OAC1CM,EAAcW,GAAS,aAAejB,EAAM,OAAOO,GAAKA,EAAE,SAAW,SAAS,EAAE,OAEhFa,EAAgBpB,EACnB,IAAIK,GAAQ,CACX,MAAMgB,EACJhB,EAAK,SAAW,UAAY,IAAMA,EAAK,SAAW,UAAY,IAAM,KAChEiB,EACJjB,EAAK,SAAW,UAAY,UAAYA,EAAK,SAAW,UAAY,UAAY,UAElF,MAAO,OAAOA,EAAK,aAAe,KAAK,OAAOA,EAAK,QAAQ,MAAMgB,CAAW,IAAIC,CAAU,GAAGjB,EAAK,MAAQ,MAAMA,EAAK,KAAK,KAAO,EAAE,EACrI,CAAC,EACA,KAAK;AAAA,CAAI,EAEZ,MAAO;AAAA;AAAA;AAAA,iBAGQP,CAAS;AAAA,iBACTkB,CAAS;AAAA,YACdE,CAAa;AAAA;AAAA;AAAA,uBAGFC,CAAU;AAAA,sBACXb,CAAW;AAAA;AAAA;AAAA,EAG/Bc,CAAa;AAAA;AAAA;AAAA;AAAA,EAIb,KAAA,CACF"}